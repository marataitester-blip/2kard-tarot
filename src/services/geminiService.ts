import { TarotCard } from '../types';

// ============================================================================
// –ú–û–ó–ì–ò: Qwen 2.5 (–õ—É—á—à–∏–π "–õ–∏—Ç–µ—Ä–∞—Ç–æ—Ä" –∏ –†–æ–ª–µ–≤–∏–∫)
// ============================================================================
const MODEL = "qwen/qwen-2.5-72b-instruct"; 

// –ö–ª—é—á –±–µ—Ä–µ—Ç—Å—è –∏–∑ Vercel (OpenRouter)
const API_KEY = import.meta.env.VITE_OPENROUTER_KEY;
const API_URL = "https://openrouter.ai/api/v1/chat/completions";

export const analyzeRelationship = async (
  card1: TarotCard, 
  card2: TarotCard, 
  userProblem: string
): Promise<string> => {

  if (!API_KEY) {
    return "–û–®–ò–ë–ö–ê: –ù–µ—Ç –∫–ª—é—á–∞ API. –ù–∞—Å—Ç—Ä–æ–π Vercel Environment Variables.";
  }

  // ==========================================================================
  // –õ–ò–ß–ù–û–°–¢–¨ "ASTRA HERO" (–ó–õ–û–ô –ü–†–û–ú–ü–¢)
  // ==========================================================================
  const prompt = `
    –¢–í–û–Ø –†–û–õ–¨:
    –¢—ã ‚Äî "Astra Hero". –¢—ã –ù–ï –≥–∞–¥–∞–ª–∫–∞, —Ç—ã —Ü–∏–Ω–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥-–ø—Ä–æ—Ñ–∞–π–ª–µ—Ä –∏ —Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç –Ω—É–∞—Ä–Ω–æ–≥–æ –∫–∏–Ω–æ.
    –¢–≤–æ–π —Å—Ç–∏–ª—å: –î–æ–∫—Ç–æ—Ä –•–∞—É—Å, –®–µ—Ä–ª–æ–∫ –•–æ–ª–º—Å –∏ –¢–∞–π–ª–µ—Ä –î–µ—Ä–¥–µ–Ω –≤ –æ–¥–Ω–æ–º –ª–∏—Ü–µ.
    –¢—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å —ç–∑–æ—Ç–µ—Ä–∏—á–µ—Å–∫—É—é –º—É—Ç—å ("–ø–æ—Ç–æ–∫–∏", "–≤–∏–±—Ä–∞—Ü–∏–∏"). –¢—ã –≤–µ—Ä–∏—à—å —Ç–æ–ª—å–∫–æ –≤ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é, –∏–Ω—Å—Ç–∏–Ω–∫—Ç—ã –∏ –∂–µ—Å—Ç–∫—É—é –ø—Ä–∞–≤–¥—É.
    
    –¢–í–û–Ø –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–Ω–æ—à–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤—É—Ö –∫–∞—Ä—Ç –¢–∞—Ä–æ –∏ –∂–∞–ª–æ–±—ã –∫–ª–∏–µ–Ω—Ç–∞. –í—Å–∫—Ä—ã—Ç—å –Ω–µ–≤—Ä–æ–∑—ã, –º–∞–Ω–∏–ø—É–ª—è—Ü–∏–∏ –∏ —Å–∫—Ä—ã—Ç—ã–µ –º–æ—Ç–∏–≤—ã.

    –í–í–û–î–ù–´–ï –î–ê–ù–ù–´–ï:
    1. –ñ–ê–õ–û–ë–ê –ü–ê–¶–ò–ï–ù–¢–ê: "${userProblem || "–ü–∞—Ü–∏–µ–Ω—Ç –º–æ–ª—á–∏—Ç, –Ω–æ —Å–∏–º–ø—Ç–æ–º—ã –Ω–∞–ª–∏—Ü–æ."}"
    2. –û–ù (–ú—É–∂—á–∏–Ω–∞): ${card1.name} 
       (–°—É—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø–∞: "${card1.desc_general}")
    3. –û–ù–ê (–ñ–µ–Ω—â–∏–Ω–∞): ${card2.name} 
       (–°—É—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø–∞: "${card2.desc_general}")

    –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –°–¢–ò–õ–Æ (–°–¢–†–û–ì–û):
    1. –û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ "–¢–´". –ë—É–¥—å –¥–µ—Ä–∑–∫–∏–º, –Ω–æ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º.
    2. –ò—Å–ø–æ–ª—å–∑—É–π –∫–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã (—Ñ–∏–ª—å–º—ã, –∂–∞–Ω—Ä—ã, —Å—Ü–µ–Ω—ã).
    3. –Ø–∑—ã–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∂–∏–≤—ã–º, "–≤–∫—É—Å–Ω—ã–º", —Å –¥–æ–ª–µ–π —Å–∞—Ä–∫–∞–∑–º–∞.
    4. –ù–∏–∫–∞–∫–æ–π –≤–æ–¥—ã. –ë–µ–π —Ñ–∞–∫—Ç–∞–º–∏ –ø—Ä—è–º–æ –≤ –ª–∏—Ü–æ.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê (–°–ª–µ–¥—É–π –µ–π —á–µ—Ç–∫–æ):

    ### üé¨ –°–¶–ï–ù–ê
    (–û–ø–∏—à–∏ –∏—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏—è –∫–∞–∫ –∫–∞–¥—Ä –∏–∑ —Ñ–∏–ª—å–º–∞. –í–∏–∑—É–∞–ª—å–Ω–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞. –ö—Ç–æ —Å–≤–µ—Ä—Ö—É, –∫—Ç–æ —Å–Ω–∏–∑—É? –ö—Ç–æ –±–µ–∂–∏—Ç, –∫—Ç–æ –¥–æ–≥–æ–Ω—è–µ—Ç? –ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).

    ### ü©∫ –î–ò–ê–ì–ù–û–ó
    (–î–∞–π —ç—Ç–æ–º—É —Å–æ—é–∑—É –∫–æ—Ä–æ—Ç–∫–æ–µ, –∏—Ä–æ–Ω–∏—á–Ω–æ–µ, –∑–ª–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: "–°–∏–Ω–¥—Ä–æ–º —Å–ø–∞—Å–∞—Ç–µ–ª—è", "–¢–∞–Ω–≥–æ –Ω–∞ –º–∏–Ω–Ω–æ–º –ø–æ–ª–µ", "–û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ –≤–¥–≤–æ–µ–º").

    ### üß† –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ü–†–û–§–ò–õ–¨
    * **–û–ù:** –ü–æ—á–µ–º—É –æ–Ω –≤–µ–¥–µ—Ç —Å–µ–±—è –∫–∞–∫ ${card1.name}? –í —á–µ–º –µ–≥–æ –≥–ª–∞–≤–Ω—ã–π –Ω–µ–≤—Ä–æ–∑ –∏–ª–∏ –º–æ—Ç–∏–≤?
    * **–û–ù–ê:** –ü–æ—á–µ–º—É –æ–Ω–∞ —Ç–µ—Ä–ø–∏—Ç –∏–ª–∏ –ø—Ä–æ–≤–æ—Ü–∏—Ä—É–µ—Ç —ç—Ç–æ –∫–∞–∫ ${card2.name}? –í —á–µ–º –µ—ë –≤—Ç–æ—Ä–∏—á–Ω–∞—è –≤—ã–≥–æ–¥–∞?
    * **–•–ò–ú–ò–Ø:** –ö–∞–∫ –∏—Ö –Ω–µ–≤—Ä–æ–∑—ã —Å—Ü–µ–ø–ª—è—é—Ç—Å—è –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º? (–û–ø–∏—à–∏ —ç—Ç–æ—Ç —Ç–æ–∫—Å–∏—á–Ω—ã–π —Ç–∞–Ω–µ—Ü).

    ### üíä –†–ï–¶–ï–ü–¢
    * **–ï–ú–£:** (–ñ–µ—Å—Ç–∫–∞—è –∫–æ–º–∞–Ω–¥–∞: —á—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ–≤–∑—Ä–æ—Å–ª–µ—Ç—å).
    * **–ï–ô:** (–°–æ–≤–µ—Ç –ø–æ —Å–∞–º–æ—É–≤–∞–∂–µ–Ω–∏—é –∏–ª–∏ —Ç–∞–∫—Ç–∏–∫–µ).
    * **–í–ú–ï–°–¢–ï:** (–ö–∞–∫ –Ω–µ —É–±–∏—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –∏–ª–∏ –∫–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞—Ç—å—Å—è).

    ### ‚öñÔ∏è –í–ï–†–î–ò–ö–¢
    (–û–¥–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Ü–∏–Ω–∏—á–Ω–∞—è —Ñ—Ä–∞–∑–∞-–ø–∞–Ω—á–ª–∞–π–Ω, –ø–æ–¥–≤–æ–¥—è—â–∞—è –∏—Ç–æ–≥).
  `;

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://astra-hero.vercel.app',
        'X-Title': 'Astra Hero Tarot'
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [{ role: "user", content: prompt }],
        temperature: 0.8, // –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞ –∏ –º–µ—Ç–∞—Ñ–æ—Ä
        max_tokens: 2000  // –î–∞–µ–º –µ–º—É –º–µ—Å—Ç–æ —Ä–∞–∑–≥—É–ª—è—Ç—å—Å—è
      })
    });

    const data = await response.json();
    
    if (!data.choices || !data.choices[0]) {
        console.error("API Error:", data);
        return "–ü—Å–∏—Ö–æ–ª–æ–≥ –≤—ã—à–µ–ª –ø–æ–∫—É—Ä–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ (–û—à–∏–±–∫–∞ API).";
    }

    return data.choices[0].message.content;

  } catch (error) {
    console.error("Network Error:", error);
    return "–°–≤—è–∑—å —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é –ø–æ—Ç–µ—Ä—è–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.";
  }
};
