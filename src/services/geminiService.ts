import { TarotCard } from '../types';

// –ò—Å–ø–æ–ª—å–∑—É–µ–º Qwen 2.5 ‚Äî –æ–Ω –ª—É—á—à–∏–π –ø–∏—Å–∞—Ç–µ–ª—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º –∑–∞ —ç—Ç–∏ –¥–µ–Ω—å–≥–∏
const MODEL = "qwen/qwen-2.5-72b-instruct"; 

const API_KEY = import.meta.env.VITE_OPENROUTER_KEY;
const API_URL = "https://openrouter.ai/api/v1/chat/completions";

export const analyzeRelationship = async (
  card1: TarotCard, 
  card2: TarotCard, 
  userProblem: string
): Promise<string> => {

  if (!API_KEY) {
    return "–û–®–ò–ë–ö–ê: –ù–µ—Ç API –∫–ª—é—á–∞. –ù–∞—Å—Ç—Ä–æ–π Vercel.";
  }

  // === –õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ü–†–û–ú–ü–¢ –î–õ–Ø QWEN ===
  const prompt = `
    –¢–í–û–Ø –†–û–õ–¨:
    –¢—ã ‚Äî "Astra Hero", —Ü–∏–Ω–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥-–ø—Ä–æ—Ñ–∞–π–ª–µ—Ä —Å –Ω–∞–≤—ã–∫–∞–º–∏ —Ç–∞—Ä–æ–ª–æ–≥–∞. –¢–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä: –¥–æ–∫—Ç–æ—Ä –•–∞—É—Å —Å–º–µ—à–∞–Ω–Ω—ã–π —Å –Ω—É–∞—Ä–Ω—ã–º –¥–µ—Ç–µ–∫—Ç–∏–≤–æ–º. –¢—ã –Ω–µ –≤–µ—Ä–∏—à—å –≤ –º–∞–≥–∏—é, —Ç—ã –≤–µ—Ä–∏—à—å –≤ –Ω–µ–≤—Ä–æ–∑—ã –∏ –ø—Å–∏—Ö–æ—Ç–∏–ø—ã. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –∂–µ—Å—Ç–∫—É—é –ø—Ä–∞–≤–¥—É, –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —á–µ—Ä–Ω—ã–π —é–º–æ—Ä, –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –ø—Ä—è–º—É—é —Ä–µ—á—å.

    –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–≤–µ–¥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–≤—É—Ö –∫–∞—Ä—Ç –∏ –∂–∞–ª–æ–±—ã –∫–ª–∏–µ–Ω—Ç–∞.
    –≠—Ç–æ –Ω–µ –≥–∞–¥–∞–Ω–∏–µ, —ç—Ç–æ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –≤–∏–≤–∏—Å–µ–∫—Ü–∏—è.

    –î–ê–ù–ù–´–ï:
    1. –ñ–ê–õ–û–ë–ê –ö–õ–ò–ï–ù–¢–ê: "${userProblem || "–ö–ª–∏–µ–Ω—Ç –º–æ–ª—á–∏—Ç, –Ω–æ –∫–∞—Ä—Ç—ã –∫—Ä–∏—á–∞—Ç."}"
    2. –ö–ê–†–¢–ê "–û–ù" (–ú—É–∂—á–∏–Ω–∞): ${card1.name} 
       (–°—É—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø–∞: "${card1.desc_general}")
    3. –ö–ê–†–¢–ê "–û–ù–ê" (–ñ–µ–Ω—â–∏–Ω–∞): ${card2.name} 
       (–°—É—Ç—å –∞—Ä—Ö–µ—Ç–∏–ø–∞: "${card2.desc_general}")

    –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –°–¢–ò–õ–Æ (–í–ê–ñ–ù–û):
    - –ü–∏—à–∏ –Ω–∞ –∂–∏–≤–æ–º, —Å–æ—á–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
    - –ò–°–ü–û–õ–¨–ó–£–ô –ü–†–Ø–ú–£–Æ –†–ï–ß–¨. –û–±—Ä–∞—â–∞–π—Å—è –∫ –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ "—Ç—ã".
    - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (bullet points), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ä–µ—Ü–µ–ø—Ç. –õ—É—á—à–µ —Å–≤—è–∑–Ω—ã–π —Ç–µ–∫—Å—Ç.
    - –ë—É–¥—å –∏—Ä–æ–Ω–∏—á–Ω—ã–º.

    –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê:

    1. üé¨ –°–¶–ï–ù–ê
    (–û–ø–∏—à–∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –∫–∞–∫ —Å—Ü–µ–Ω—É –∏–∑ —Ñ–∏–ª—å–º–∞. –ö—Ç–æ –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç? –ö—Ç–æ –∂–µ—Ä—Ç–≤–∞? –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤–∏–∑—É–∞–ª—å–Ω–æ).

    2. ü©∫ –î–ò–ê–ì–ù–û–ó
    (–ö–æ—Ä–æ—Ç–∫–æ–µ, –∑–ª–æ–µ, —Å–º–µ—à–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Ö —Å–æ—é–∑–∞. –ù–∞–ø—Ä–∏–º–µ—Ä: "–¢–∞–Ω–≥–æ –Ω–∞ –º–∏–Ω–Ω–æ–º –ø–æ–ª–µ" –∏–ª–∏ "–°–æ—é–∑ –∂–µ—Ä—Ç–≤—ã –∏ –ø–∞–ª–∞—á–∞").

    3. üó£Ô∏è –†–ê–ó–ì–û–í–û–† –ü–û –î–£–®–ê–ú (–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å)
    (–û–±—Ä–∞—Ç–∏—Å—å –∫ –∫–ª–∏–µ–Ω—Ç—É. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É –û–ù –≤–µ–¥–µ—Ç —Å–µ–±—è —Ç–∞–∫ (–∏—Å—Ö–æ–¥—è –∏–∑ –∫–∞—Ä—Ç—ã 1), –∏ –ø–æ—á–µ–º—É –û–ù–ê —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —Ç–∞–∫ (–∏—Å—Ö–æ–¥—è –∏–∑ –∫–∞—Ä—Ç—ã 2). –í—Å–∫—Ä–æ–π –∏—Ö "—Ö–∏–º–∏—é" –∏ —Ç—Ä–∞–≤–º—ã. –ü–∏—à–∏ –∫–∞–∫ –º–æ–Ω–æ–ª–æ–≥ –¥–æ–∫—Ç–æ—Ä–∞).

    4. üíä –†–ï–¶–ï–ü–¢
    - –ï–ú–£: (–ñ–µ—Å—Ç–∫–∏–π —Å–æ–≤–µ—Ç)
    - –ï–ô: (–°–æ–≤–µ—Ç –ø–æ –∑–∞–∑–µ–º–ª–µ–Ω–∏—é)
    - –ò–¢–û–ì: (–§–∏–Ω–∞–ª—å–Ω–∞—è —Ñ—Ä–∞–∑–∞-–ø–∞–Ω—á–ª–∞–π–Ω).
  `;

  try {
    const response = await fetch(API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_KEY}`,
        'Content-Type': 'application/json',
        'HTTP-Referer': 'https://astra-hero.vercel.app',
        'X-Title': 'Astra Hero Tarot'
      },
      body: JSON.stringify({
        model: MODEL,
        messages: [{ role: "user", content: prompt }],
        temperature: 0.8, // –í—ã—Å–æ–∫–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –∫—Ä–µ–∞—Ç–∏–≤–∞
        max_tokens: 1500
      })
    });

    const data = await response.json();
    return data.choices?.[0]?.message?.content || "–û—Ä–∞–∫—É–ª —É—à–µ–ª –∫—É—Ä–∏—Ç—å. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.";

  } catch (error) {
    return "–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. –í–æ–∑–º–æ–∂–Ω–æ, —Ä–µ—Ç—Ä–æ–≥—Ä–∞–¥–Ω—ã–π –ú–µ—Ä–∫—É—Ä–∏–π –ø–µ—Ä–µ–≥—Ä—ã–∑ –∫–∞–±–µ–ª—å.";
  }
};
