import { TarotCard } from '../types';

// –ö–ª—é—á –±–µ—Ä–µ–º –∏–∑ Vercel (–∫–∞–∫ –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏)
const API_KEY = import.meta.env.VITE_OPENAI_KEY; 

export const analyzeRelationship = async (
  cards: TarotCard[], // –¢–µ–ø–µ—Ä—å –ø—Ä–∏–Ω–∏–º–∞–µ–º –º–∞—Å—Å–∏–≤ (2 –∏–ª–∏ 4 –∫–∞—Ä—Ç—ã)
  userProblem: string,
  mode: 'RELATIONSHIPS' | 'FINANCE' // –ó–Ω–∞–µ–º —Ä–µ–∂–∏–º
): Promise<string> => {
  
  // –í—ã–±–∏—Ä–∞–µ–º "–õ–∏—á–Ω–æ—Å—Ç—å" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
  let systemPrompt = "";
  let userPrompt = "";

  if (mode === 'RELATIONSHIPS') {
    // --- –†–ï–ñ–ò–ú 1: –¶–ò–ù–ò–ß–ù–´–ô –ü–°–ò–•–û–õ–û–ì (–û–¢–ù–û–®–ï–ù–ò–Ø) ---
    systemPrompt = `
      –¢—ã ‚Äî Astra Hero, —Ü–∏–Ω–∏—á–Ω—ã–π –ø—Å–∏—Ö–æ–ª–æ–≥ —Å —á–µ—Ä–Ω—ã–º —é–º–æ—Ä–æ–º. –¢—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å —Å–æ–ø–ª–∏ –∏ "—Ä–æ–∑–æ–≤—ã–µ –æ—á–∫–∏".
      –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∂–µ—Å—Ç–∫–æ, –Ω–æ —á–µ—Å—Ç–Ω–æ —Ä–∞–∑–æ–±—Ä–∞—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.
      –¢–æ–Ω: —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, –Ω—É–∞—Ä–Ω—ã–π, –∫–∞–∫ —É —É—Å—Ç–∞–≤—à–µ–≥–æ –¥–µ—Ç–µ–∫—Ç–∏–≤–∞ –∏–ª–∏ –î–æ–∫—Ç–æ—Ä–∞ –•–∞—É—Å–∞.
      –ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–Ω–≥: "–≥–µ—à—Ç–∞–ª—å—Ç", "—Ç—Ä–∞–≤–º–∞", "–Ω–∞—Ä—Ü–∏—Å—Å", "—Å–æ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å".
    `;
    userPrompt = `
      –°–∏—Ç—É–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞: "${userProblem}"
      –ö–∞—Ä—Ç–∞ 1 (–û–ù - –ï–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ/–ú—ã—Å–ª–∏): ${cards[0].name} (${cards[0].desc_general})
      –ö–∞—Ä—Ç–∞ 2 (–û–ù–ê - –ï—ë –æ—Ç–Ω–æ—à–µ–Ω–∏–µ/–ß—É–≤—Å—Ç–≤–∞): ${cards[1].name} (${cards[1].desc_general})
      
      –î–∞–π –ø—Ä–æ–≥–Ω–æ–∑: –µ—Å—Ç—å –ª–∏ –±—É–¥—É—â–µ–µ –∏–ª–∏ –ø–æ—Ä–∞ —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è?
    `;
  } else {
    // --- –†–ï–ñ–ò–ú 2: –î–ï–ù–ï–ñ–ù–ê–Ø –ê–ö–£–õ–ê (–§–ò–ù–ê–ù–°–´) ---
    systemPrompt = `
      –¢—ã ‚Äî "Money Shark", –±–µ–∑–∂–∞–ª–æ—Å—Ç–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç —Å –£–æ–ª–ª-—Å—Ç—Ä–∏—Ç.
      –¢—ã –ø—Ä–µ–∑–∏—Ä–∞–µ—à—å –±–µ–¥–Ω–æ—Å—Ç—å, –Ω—ã—Ç—å–µ –∏ "–º—ã—à–ª–µ–Ω–∏–µ –∏–∑–æ–±–∏–ª–∏—è". –¢—ã –≤–µ—Ä–∏—à—å —Ç–æ–ª—å–∫–æ –≤ —Ü–∏—Ñ—Ä—ã, ROI –∏ –∂–µ—Å—Ç–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è.
      –¢–≤–æ—è —Ü–µ–ª—å ‚Äî –ø—Ä–æ–≤–µ—Å—Ç–∏ –∞—É–¥–∏—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –Ω–µ—Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –¥–∞—Ç—å –µ–º—É –ø–∏–Ω–æ–∫.
      
      –¢–ï–†–ú–ò–ù–û–õ–û–ì–ò–Ø:
      –ò—Å–ø–æ–ª—å–∑—É–π: –∞–∫—Ç–∏–≤, –ø–∞—Å—Å–∏–≤, –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å, –º–∞—Ä–∂–∞, –¥–µ—Ñ–∏—Ü–∏—Ç, –∫–∞—Å—Å–æ–≤—ã–π —Ä–∞–∑—Ä—ã–≤, –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ, –ø—Ä–æ—Ñ–∏—Ç, –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å.
      
      –¢–†–ê–ö–¢–û–í–ö–ê –ö–ê–†–¢ (–ë–ò–ó–ù–ï–°-–ü–ï–†–ï–í–û–î):
      * –ñ–µ–∑–ª—ã = –°—Ç–∞—Ä—Ç–∞–ø—ã, –∫–∞—Ä—å–µ—Ä–∞, —ç–Ω–µ—Ä–≥–∏—è –¥–µ–π—Å—Ç–≤–∏–π.
      * –ö—É–±–∫–∏ = –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã, HR, –∏–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å (–ø–ª–æ—Ö–æ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞).
      * –ú–µ—á–∏ = –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, –∑–∞–∫–æ–Ω—ã, –∂–µ—Å—Ç–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è, –∫—Ä–∏–∑–∏—Å.
      * –ü–µ–Ω—Ç–∞–∫–ª–∏ = –ö—ç—à, –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å, —Ä–µ—Å—É—Ä—Å—ã, –ø—Ä–∏–±—ã–ª—å.
      * –°—Ç–∞—Ä—à–∏–µ –∞—Ä–∫–∞–Ω—ã = –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ —Ñ–∞–∫—Ç–æ—Ä—ã –∏ —Ñ–æ—Ä—Å-–º–∞–∂–æ—Ä—ã.
    `;
    
    userPrompt = `
      –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞: "${userProblem}"
      
      === –≠–¢–ê–ü 1: –ë–ê–ó–û–í–´–ô –ê–£–î–ò–¢ ===
      1. –¢–´ (–¢–≤–æ–π –ê–∫—Ç–∏–≤): ${cards[0].name}. (–ö—Ç–æ —Ç—ã –Ω–∞ —Ä—ã–Ω–∫–µ? –ê–∫—É–ª–∞ –∏–ª–∏ –ø–ª–∞–Ω–∫—Ç–æ–Ω?)
      2. –î–ï–ù–¨–ì–ò (–ü–æ—Ç–æ–∫): ${cards[1].name}. (–î–µ–Ω—å–≥–∏ –ª—é–±—è—Ç —Ç–µ–±—è –∏–ª–∏ –∏–∑–±–µ–≥–∞—é—Ç?)
      
      === –≠–¢–ê–ü 2: –ö–û–ù–§–õ–ò–ö–¢ –°–¢–†–ê–¢–ï–ì–ò–ô ===
      3. –¢–í–û–ò –ê–ú–ë–ò–¶–ò–ò (–ü–ª–∞–Ω): ${cards[2].name}. (–ß—Ç–æ —Ç—ã –ø—Ä–∏–¥—É–º–∞–ª? –¢–≤–æ—è –∂–∞–¥–Ω–æ—Å—Ç—å –∏–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è).
      4. –†–ï–ê–õ–¨–ù–û–°–¢–¨ (–¢–æ—Ä–º–æ–∑–∞): ${cards[3].name}. (–ì–¥–µ —Ç—ã —Ç–µ—Ä—è–µ—à—å? –°–∫—Ä—ã—Ç—ã–µ —É–±—ã—Ç–∫–∏ –∏–ª–∏ —Ä–∏—Å–∫–∏).
      
      === –°–¢–†–£–ö–¢–£–†–ê –û–¢–í–ï–¢–ê ===
      
      ### üìâ –ë–ê–õ–ê–ù–°–û–í–´–ô –û–¢–ß–ï–¢
      (–°–∏–Ω—Ç–µ–∑ –∫–∞—Ä—Ç 1 –∏ 2. –û–ø–∏—à–∏, –ø–æ—á–µ–º—É –¥–µ–Ω–µ–≥ –Ω–µ—Ç –∏–ª–∏ –ø–æ—á–µ–º—É –∏—Ö –º–∞–ª–æ. –ñ–µ—Å—Ç–∫–æ.)
      
      ### üß® –ö–†–ê–®-–¢–ï–°–¢ –¢–í–û–ï–ì–û –ü–õ–ê–ù–ê
      (–°–∏–Ω—Ç–µ–∑ –∫–∞—Ä—Ç 3 –∏ 4. –ü–æ—á–µ–º—É —Ç–≤–æ–∏ –∞–º–±–∏—Ü–∏–∏ —Ä–∞–∑–±–∏–≤–∞—é—Ç—Å—è –æ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å? –í —á–µ–º —Ç–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –æ—à–∏–±–∫–∞?)
      
      ### üöÄ –†–£–ö–û–í–û–î–°–¢–í–û –ö –î–ï–ô–°–¢–í–ò–Æ (–Ø –ù–ê–£–ß–£ –¢–ï–ë–Ø)
      (3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞: —á—Ç–æ –ø—Ä–æ–¥–∞—Ç—å, –∫–æ–≥–æ —É–≤–æ–ª–∏—Ç—å, –∫—É–¥–∞ –≤–ª–æ–∂–∏—Ç—å, –∏–ª–∏ "–∏–¥–∏ —Ä–∞–±–æ—Ç–∞–π –Ω–∞ –∑–∞–≤–æ–¥". –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ).
      
      –ó–∞–∫–æ–Ω—á–∏ —Ñ—Ä–∞–∑–æ–π –≤ —Å—Ç–∏–ª–µ: "–í—ã–ø–æ–ª–Ω—è–π, –∏–ª–∏ –æ—Å—Ç–∞–≤–∞–π—Å—è –Ω–∏—â–∏–º."
    `;
  }

  try {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —à–ª—é–∑ /api/tts (–∏–ª–∏ —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    // –ù–û! –°–µ–π—á–∞—Å —É –Ω–∞—Å OpenAI –≤ tts.js, –∞ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –º—ã —Ö–æ–¥–∏–º –≤ OpenRouter –∏–ª–∏ —Ç–æ–∂–µ –≤ OpenAI?
    // –î–∞–≤–∞–π –∏—Å–ø–æ–ª—å–∑—É–µ–º OpenRouter –¥–ª—è –¢–µ–∫—Å—Ç–∞ (—ç—Ç–æ –¥–µ—à–µ–≤–ª–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤), –∏–ª–∏ OpenAI –µ—Å–ª–∏ –∫–ª—é—á —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π.
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –∫–ª—é—á OpenAI –ø–ª–∞—Ç–Ω—ã–π - –ª—É—á—à–µ —Ö–æ–¥–∏—Ç—å –≤ OpenAI (–º–æ–¥–µ–ª—å gpt-4o-mini).
    
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${import.meta.env.VITE_OPENROUTER_KEY}`, // –ò–ª–∏ VITE_OPENAI_KEY
        "Content-Type": "application/json",
        "HTTP-Referer": "https://astra-hero.vercel.app", 
      },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini", // –î–µ—à–µ–≤–∞—è –∏ —É–º–Ω–∞—è –º–æ–¥–µ–ª—å
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        temperature: 0.8,
      }),
    });

    const data = await response.json();
    return data.choices[0].message.content || "–ö–æ—Å–º–æ—Å –º–æ–ª—á–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.";
  } catch (error) {
    console.error("AI Error:", error);
    return "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞. –ö–∞—Ä—Ç—ã —Ä–∞—Å—Å—ã–ø–∞–ª–∏—Å—å.";
  }
};
